<div class="fp-upload-form">
    {{#options}}
    <div class="fp-content-center">
        {{! <form enctype="multipart/form-data" method="POST" class="form"> }}
            <div class="fp-formset">
                <div class="fp-file form-group">
                    <input id="fileToUpload_{{client_id}}" type="file" class="fileToUpload" style="display: none;" 
                           data-client_id="{{client_id}}" 
                           data-title="{{title}}" 
                           data-author="{{author}}" 
                           data-license="{{defaultlicense}}" 
                           data-itemid="{{itemid}}" 
                           data-p="{{p}}" 
                           data-page="{{page}}" 
                           data-env="filemanager" 
                           data-sesskey="{{sesskey}}" 
                           data-itemid="{{itemid}}" 
                           data-maxbytes="{{maxbytes}}" 
                           data-areamaxbytes="{{areamaxbytes}}" 
                           data-ctx_id="{{context.id}}" 
                           data-savepath="{{path.0.path}}" 
                           data-repo_id="4" 
                           />
                    <input type="button" value="Adicionar arquivo"  data-client_id="{{client_id}}" class="fileToUploadButton"  />
                </div>
                <div hidden="hidden" class="fp-saveas form-group">
                    <label>{{#str}}saveas, repository{{/str}}</label>
                    <input type="text" class="form-control"/>
                </div>
                <div hidden="hidden" class="fp-setauthor form-group">
                    <label>{{#str}}author, repository{{/str}}</label>
                    <input type="text" class="form-control"/>
                </div>
                <div hidden="hidden" class="fp-setlicense control-group">
                    <label>{{#str}}chooselicense, repository{{/str}}</label>
                    <select class="custom-select"></select>
                </div>
            </div>
        {{! </form> }}
    </div>
    <div id="filemanager-{{{client_id}}}" class="filemanager w-100 fm-loading">
        <p><br>Arquivos adicionados:</p>
        <ol id="fileToUploadList_{{client_id}}">
        </ol>
    </div>
    {{/options}}
</div>








{{#js}}
function ledor_readble_filesize(file) {
    if (file.size > 1024 * 1024){
        fileSize = (Math.round(file.size * 100 / (1024 * 1024)) / 100).toString() + 'MB';
    }
    else{
        fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + 'KB';
    }
    return fileSize;
}

// Read cookie
function readCookie(name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(';');
    for(var i=0;i < ca.length;i++) {
        var c = ca[i];
        while (c.charAt(0) === ' ') {
            c = c.substring(1,c.length);
        }
        if (c.indexOf(nameEQ) === 0) {
            return c.substring(nameEQ.length,c.length);
        }
    }
    return null;
}


getSoundBip_file = null;
function getSoundBip() {
    if (getSoundBip_file == null) {getSoundBip_file = new Audio('../audio/bip.mp3')}
    getSoundBip_file.loop=true
    return getSoundBip_file;
}

getSoundSelect_file = null;
var getSoundSelect = function() {
    if (getSoundSelect_file == null) {getSoundSelect_file = new Audio('../audio/selArquivo.mp3')}
    return getSoundSelect_file;
}


getSoundError_file = null;
var getSoundError = function() {
    if (getSoundError_file == null) {getSoundError_file = new Audio('../audio/erroEnvio.mp3')}
    return getSoundError_file;
}

getSoundSent_file = null;
function getSoundSent(acao) {
    if (getSoundSent_file == null) {getSoundSent_file = new Audio('../audio/enviado.mp3')}
    return getSoundSent_file;
}


require(
    ['jquery'], 
    function($){
        var _soundSelect = null; 
        var _soundBip = null;
        var rootMoodle = "/moodle";
        var uploadUrl = rootMoodle + "/repository/repository_ajax.php?action=upload";

        $('.fileToUploadButton').click(function(evt){
            getSoundSelect().play();
            $(evt.target).prev().click();
        });
        
        $('.fileToUpload').change(function(evt){
            var elem = evt.target;
            for (var index = 0; index < elem.files.length; index ++){
                var file = elem.files[index];
                var formData = new FormData();
                formData.append('repo_upload_file', file);
                for (var key in  elem.dataset) {
                    formData.append(key, elem.dataset[key])
                }
                formData.append('meusess', readCookie(''))
                
                getSoundBip().play();
                $.ajax({url: uploadUrl, 
                        type: "POST", 
                        data: formData,
                        contentType: false, 
                        cache: false, 
                        processData: false, 
                        success: function(data) {
                            getSoundBip().pause();
                            if (data['error']) {
                                getSoundError().play();
                                return;
                            }
                            $('#fileToUploadList_' + elem.dataset.client_id).append('<li><a href="#">' + file.name + '</a> (' + ledor_readble_filesize(file) + ')</li>');
                            getSoundSent().play();
                        }, 
                        error: function(data) {
                            getSoundBip().pause();
                            getSoundError().play();
                        }
                });
                // RESPONSE: {"url":"http:\/\/localhost\/moodle\/draftfile.php\/5\/user\/draft\/587326704\/exemplo.pdf","id":587326704,"file":"exemplo.pdf"}

                
            }
        });
    }
);
{{/js}}